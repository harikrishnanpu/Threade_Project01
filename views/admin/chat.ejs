<!-- views/admin/chat.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Live Chat</title>

  <!-- Icons & Inter font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>

  <style>
    /* ---------- Design Tokens (same palette) ---------- */
    :root{
      --primary:#2563eb; --primary-hover:#1d4ed8; --primary-light:#dbeafe;
      --accent:#000;     --accent-dark:#000;
      --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db;
      --gray-400:#9ca3af;--gray-500:#6b7280; --gray-600:#4b5563; --gray-700:#374151;
      --gray-800:#1f2937;--gray-900:#111827; --white:#fff;
      --radius:12px;     --shadow:0 4px 6px -1px rgb(0 0 0 /.1),0 2px 4px -2px rgb(0 0 0 /.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 /.1),0 4px 6px -4px rgb(0 0 0 /.1);
      --transition:all .25s cubic-bezier(.4,0,.2,1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Inter",system-ui,sans-serif;
      background:var(--gray-50);
      color:var(--gray-900);
      height:100vh;display:flex;
    }

    /* ---------- Layout ---------- */
    .sidebar{
      width:280px;max-width:100%;background:var(--white);display:flex;flex-direction:column;
      border-right:1px solid var(--gray-200);box-shadow:var(--shadow);
    }
    .sidebar-header{
      padding:1.25rem 1.5rem;font-weight:600;border-bottom:1px solid var(--gray-200);
      display:flex;align-items:center;gap:.6rem
    }
    .user-list{flex:1;overflow-y:auto}
    .user-item{
      display:flex;justify-content:space-between;align-items:center;gap:.6rem;
      padding:.9rem 1.25rem;border-bottom:1px solid var(--gray-100);cursor:pointer;
      transition:background var(--transition)
    }
    .user-item:hover{background:var(--gray-100)}
    .user-item.active{background:var(--primary-light)}
    .user-name{font-size:.875rem;font-weight:500;color:var(--gray-800)}
    .badge{background:var(--primary);color:#fff;border-radius:9999px;padding:.15rem .5rem;font-size:.75rem}

    .chat-panel{flex:1;display:flex;flex-direction:column}
    .chat-header{
      padding:1.25rem 1.5rem;border-bottom:1px solid var(--gray-200);
      font-weight:600;display:flex;align-items:center;gap:.6rem
    }
    .chat-body{
      flex:1;overflow-y:auto;padding:1.25rem;display:flex;flex-direction:column;gap:1rem;
      background:var(--gray-50)
    }
    .msg{
      max-width:75%;padding:.7rem 1rem;border-radius:var(--radius);font-size:.9rem;line-height:1.5;
      box-shadow:var(--shadow);word-break:break-word
    }
    .from-admin{align-self:flex-end;background:var(--primary);color:#fff}
    .from-user{align-self:flex-start;background:var(--white)}
    .chat-footer{
      padding:.9rem 1rem;border-top:1px solid var(--gray-200);display:flex;gap:.6rem;background:var(--white)
    }
    #msgInput{flex:1;border:2px solid var(--gray-300);border-radius:var(--radius);padding:.55rem .9rem;
      transition:var(--transition);font-size:.875rem}
    #msgInput:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
    #sendBtn{
      background:var(--primary);color:#fff;border:none;border-radius:var(--radius);padding:.55rem 1rem;
      display:grid;place-items:center;font-size:1rem;cursor:pointer;transition:background var(--transition)
    }
    #sendBtn:hover{background:var(--primary-hover)}

    /* ---------- Responsive ---------- */
    @media(max-width:768px){
      .sidebar{width:200px}
      .chat-header{padding:1rem}
      .chat-body{padding:1rem}
      #msgInput{font-size:.8rem}
    }
  </style>
</head>
<body>
 <aside class="sidebar">
    <div class="sidebar-header"><i class="fas fa-users"></i>Active Users</div>
    <div class="user-list" id="userList"></div>
  </aside>

  <!-- chat -->
  <section class="chat-panel">
    <div class="chat-header" id="chatHeader">Select a user…</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
      <input id="msgInput" type="text" placeholder="Type a reply…" autocomplete="off" disabled>
      <button id="sendBtn" disabled><i class="fas fa-paper-plane"></i></button>
    </div>
  </section>

  <!-- Socket.IO -->
<script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
  <script>
    const socket     = io();                // one connection, same origin
    socket.emit('joinAdminRoom');           // register as admin listener

    let currentUID = null;

    /* DOM refs */
    const listEl = document.getElementById('userList'),
          bodyEl = document.getElementById('chatBody'),
          headEl = document.getElementById('chatHeader'),
          input  = document.getElementById('msgInput'),
          send   = document.getElementById('sendBtn');

    /* helpers */
    const renderUsers = users => {
      listEl.innerHTML = '';
      users.forEach(u=>{
        const row = document.createElement('div');
        row.className = 'user-item' + (u.id===currentUID?' active':'');
        row.dataset.uid = u.id;
        row.innerHTML = `<span class="user-name">${u.name||u.id}</span>`;
        listEl.appendChild(row);
      });
    };
    const addMsg = msg => {
      const div=document.createElement('div');
      div.className='msg '+(msg.from==='admin'?'from-admin':'from-user');
      div.textContent = msg.text;
      bodyEl.appendChild(div);
      bodyEl.scrollTop = bodyEl.scrollHeight;
    };

    /* sockets */
    socket.on('activeUsers', renderUsers);
    socket.on('chatMessage', msg=>{
      if(msg.from===currentUID || (msg.from==='admin' && msg.to===currentUID))
        addMsg(msg);
      else {
        const row=listEl.querySelector(`[data-uid="${msg.from}"]`);
        if(row && !row.querySelector('.badge'))
          row.insertAdjacentHTML('beforeend','<span class="badge">•</span>');
      }
    });

    /* sidebar click */
    listEl.addEventListener('click',e=>{
      const item=e.target.closest('.user-item'); if(!item) return;
      currentUID=item.dataset.uid;
      listEl.querySelectorAll('.user-item').forEach(el=>el.classList.toggle('active',el===item));
      headEl.textContent='Chat with '+item.textContent;
      bodyEl.innerHTML='';
      input.disabled=send.disabled=false;
      const badge=item.querySelector('.badge'); if(badge) badge.remove();
    });

    /* send */
    const sendMsg=()=>{
      const text=input.value.trim();
      if(!text||!currentUID) return;
      const m={from:'admin',to:currentUID,text,ts:Date.now()};
      socket.emit('chatMessage',m);
      addMsg(m);
      input.value='';
    };
    send.onclick=sendMsg;
    input.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMsg(); });
  </script>
</body></html>