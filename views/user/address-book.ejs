<!-- views/user/profile/addresses.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My addresses – <%= user.name %></title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
  :root{
    --bg:#f7f9fc;
    --white:#fff;
    --primary:#0d6efd;
    --primary-light:#e8f0ff;
    --text:#374151;
    --muted:#6b7280;
    --radius:12px;
    --tr:.25s;
  }
  *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
  body{background:var(--bg);color:var(--text);line-height:1.5}

  /* ===== layout ===== */
  .wrapper{display:flex;min-height:100dvh;max-width:1300px;margin:auto}

  /* ===== sidebar (re-use from profile pages) ===== */
  .sidebar{
    width:250px;background:var(--white);border-right:1px solid #e5e7eb;
    display:flex;flex-direction:column;padding:1.5rem 0;transition:transform var(--tr)
  }
  .avatar-box{display:flex;align-items:center;gap:.9rem;padding-inline:1.5rem;margin-bottom:1.75rem}
  .avatar{width:54px;height:54px;border-radius:50%;background:var(--primary-light);
          display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--primary);font-weight:600}
  .avatar-box p{font-size:.8rem;color:var(--muted)}
  nav ul{list-style:none}
  nav li a{display:flex;align-items:center;gap:.8rem;padding:.9rem 1.5rem;text-decoration:none;color:inherit;
           border-left:3px solid transparent;transition:background var(--tr),transform var(--tr)}
  nav li a:hover{background:#f1f5f9;transform:translateX(3px)}
  nav li a.active{border-color:var(--primary);background:var(--primary-light)}
  nav li i{width:18px;text-align:center}
  .logout{margin-top:auto;padding:.9rem 1.5rem;background:none;border:none;color:#ef4444;
          display:flex;gap:.6rem;cursor:pointer;transition:background var(--tr)}
  .logout:hover{background:#fee2e2}

  /* ===== mobile header ===== */
  .mobile-top{display:none;align-items:center;justify-content:space-between;background:var(--white);
              border-bottom:1px solid #e5e7eb;padding:1rem 1.25rem;position:sticky;top:0;}
  .mobile-btn{background:none;border:none;font-size:1.3rem}
  .overlay{display:none;position:fixed;inset:0;background:#0005;z-index:800}

  /* ===== main area ===== */
  main{flex:1;padding:2rem 2.5rem}
  h1{font-size:1.4rem;margin-bottom:1.6rem}
  .crumb{font-size:.85rem;color:var(--muted);margin-bottom:1.2rem}
  .crumb i{margin-inline:.25rem}

  /* ===== toolbar ===== */
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.3rem}
  .add-btn{padding:.55rem 1.2rem;font-size:.9rem;background:var(--primary);color:var(--white);
           border:none;border-radius:var(--radius);display:flex;align-items:center;gap:.5rem;cursor:pointer;
           transition:background var(--tr)}
  .add-btn:hover{background:#0b5be0}

  /* ===== address grid ===== */
  .addr-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .addr-card{background:var(--white);border:1px solid #e5e7eb;border-radius:var(--radius);
             padding:1.3rem;position:relative;box-shadow:0 1px 3px rgba(0,0,0,.05);transition:transform var(--tr)}
  .addr-card:hover{transform:translateY(-3px)}
  .badge-default{position:absolute;top:.9rem;right:.9rem;background:var(--primary);color:var(--white);
                 padding:.2rem .5rem;font-size:.7rem;border-radius:10px;text-transform:uppercase}
  .addr-type{font-size:.8rem;color:var(--muted);margin-top:.3rem}
  .addr-actions{display:flex;gap:.9rem;margin-top:1rem}
  .addr-actions a{font-size:.85rem;display:flex;align-items:center;gap:.25rem;text-decoration:none}
  .addr-actions .text-info{color:#0d6efd}
  .addr-actions .text-danger{color:#dc2626}

  /* ===== modal ===== */
  .modal-overlay{display:none;position:fixed;inset:0;background:#0005;z-index:1000;align-items:center;justify-content:center}
  .modal-box{background:var(--white);width:90%;max-width:480px;border-radius:var(--radius);box-shadow:0 5px 15px rgba(0,0,0,.2);display:flex;flex-direction:column;overflow:hidden}
  .modal-header{background:var(--primary);color:var(--white);padding:1rem 1.25rem;display:flex;justify-content:space-between;align-items:center}
  .modal-header h3{font-size:1rem}
  .modal-header button{background:none;border:none;font-size:1.2rem;color:inherit;cursor:pointer}
  .modal-body{padding:1.25rem;max-height:70vh;overflow-y:auto}
  .modal-footer{padding:1rem 1.25rem;display:flex;justify-content:flex-end;gap:.8rem;background:#f1f5f9}
  .modal-footer button{padding:.55rem 1.1rem;font-size:.85rem;border:none;border-radius:var(--radius);cursor:pointer}
  .btn-secondary{background:#9ca3af;color:var(--white)}
  .btn-dark{background:var(--primary);color:var(--white)}
  .btn-dark[disabled]{opacity:.6;cursor:not-allowed}

  /* ===== form elements ===== */
  .form-group{margin-bottom:1rem}
  .form-group label{font-size:.8rem;font-weight:600;color:var(--muted);display:block;margin-bottom:.3rem}
  .form-group input[type="text"],
  .form-group input[type="tel"],
  .form-group input[type="number"]{
     width:100%;padding:.7rem 1rem;border:1px solid #d1d5db;border-radius:var(--radius);
     font-size:.9rem;outline:none;transition:border-color var(--tr),box-shadow var(--tr)
  }
  .form-group input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,110,253,.15)}
  .inline{display:flex;gap:1rem}
  .inline .form-group{flex:1;margin-bottom:0}

  .error-note{font-size:.8rem;color:#dc2626;margin-top:.4rem}
  .note{grid-column:1/-1;padding:.8rem 1.1rem;border-left:4px solid;border-radius:var(--radius);font-size:.9rem;margin-bottom:1rem}
  .note.error{background:#fef2f2;border-color:#ef4444;color:#991b1b}
  .note.success{background:#f0fdf4;border-color:#22c55e;color:#166534}

  @media(max-width:768px){
    .sidebar{position:fixed;inset-block:0;left:0;z-index:850;transform:translateX(-100%)}
    .sidebar.open{transform:none}
    .mobile-top{display:flex}
    .wrapper{flex-direction:column}
    main{padding:1.25rem;margin-top:64px}
    .overlay.show{display:block}
  }
  </style>
</head>
<body>

<!-- ===== mobile header ===== -->
<div class="mobile-top">
  <button class="mobile-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
  <span>My address book</span>
  <span></span>
</div>
<div class="overlay" onclick="toggleMenu()"></div>

<div class="wrapper">
  <!-- ===== sidebar ===== -->
  <aside class="sidebar" id="side">
    <div class="avatar-box">
      <div class="avatar"><%= user.name?.[0].toUpperCase() %></div>
      <div>
        <h4 style="font-size:1rem"><%= user.name %></h4>
        <p><%= user.email %></p>
      </div>
    </div>

    <nav>
      <ul>
        <li><a href="/user/profile/"><i class="fas fa-user"></i>Personal data</a></li>
        <li><a href="/user/profile/edit"><i class="fas fa-user-edit"></i>Edit profile</a></li>
        <li><a href="/user/profile/address" class="active"><i class="fas fa-map-marker-alt"></i>Addresses</a></li>
        <li><a href="/user/profile/password"><i class="fas fa-key"></i>Password</a></li>
      </ul>
    </nav>

    <button class="logout" onclick="location.href='/logout'"><i class="fas fa-right-from-bracket"></i>Log out</button>
  </aside>

  <!-- ===== main ===== -->
  <main>
    <div class="crumb"><i class="fas fa-house"></i> Home <i class="fas fa-angle-right"></i> Account <i class="fas fa-angle-right"></i> Addresses</div>
    <h1>My address book</h1>

    <div id="pageNote"></div>

    <div class="toolbar">
      <span></span>
      <button class="add-btn" id="addBtn"><i class="fas fa-plus-circle"></i>Add address</button>
    </div>

    <div class="addr-grid">
      <% if(addresses && addresses.length){ %>
        <% addresses.forEach(a=>{ %>
          <div class="addr-card">
            <% if(a.isDefault){ %><span class="badge-default">default</span><% } %>
            <h4><%= a.fullName %></h4>
            <p style="margin:.3rem 0"><%= a.street %></p>
            <p style="margin:.3rem 0"><%= a.city %>, <%= a.state %> – <%= a.pincode %></p>
            <p style="margin:.4rem 0"><i class="fas fa-phone"></i> <%= a.phone %></p>
            <% if(a.type){ %>
              <div class="addr-type">
                <i class="fas fa-<%= a.type==='home'?'home':'briefcase' %>"></i>
                <%= a.type %>
              </div>
            <% } %>
            <div class="addr-actions">
              <a href="#" class="text-info editBtn" data-json='<%- JSON.stringify(a) %>'><i class="fas fa-edit"></i>Edit</a>
              <a href="#" class="text-danger deleteBtn" data-id="<%= a._id %>"><i class="fas fa-trash"></i>Delete</a>
            </div>
          </div>
        <% }) %>
      <% }else{ %>
        <div class="note error" style="text-align:center">No addresses yet – click “Add address”.</div>
      <% } %>
    </div>
  </main>
</div>

<!-- ===== modal ===== -->
<div class="modal-overlay" id="modal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle">Add address</h3>
      <button onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <form id="addrForm">
      <div class="modal-body">
        <input type="hidden" name="_method" id="methodField" value="POST">
        <input type="hidden" name="addressId" id="addressId">

        <div class="form-group">
          <label>Full name *</label>
          <input type="text" name="fullName" required>
        </div>

        <div class="form-group">
          <label>Phone *</label>
          <input type="tel" name="phone" required>
        </div>

        <div class="form-group">
          <label>Street *</label>
          <input type="text" name="street" required>
        </div>

        <div class="inline">
          <div class="form-group">
            <label>City *</label>
            <input type="text" name="city" required>
          </div>
          <div class="form-group">
            <label>State *</label>
            <input type="text" name="state" required>
          </div>
        </div>

        <div class="form-group">
          <label>pincode *</label>
          <input type="text" name="pincode" maxlength="12" required>
        </div>

        <div class="form-group">
          <label>Address type</label>
          <div style="display:flex;gap:1rem">
            <label style="display:flex;align-items:center;gap:.4rem">
              <input type="radio" name="addressType" value="home" checked>
              <i class="fas fa-home"></i> Home
            </label>
            <label style="display:flex;align-items:center;gap:.4rem">
              <input type="radio" name="addressType" value="work">
              <i class="fas fa-briefcase"></i> Work
            </label>
          </div>
        </div>

        <div class="form-group" style="margin-bottom:.5rem">
          <label style="display:flex;align-items:center;gap:.6rem">
            <input type="checkbox" name="isDefault" id="isDefaultBox">
            Set as default
          </label>
        </div>

        <div id="modalMsg"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn-dark" id="submitBtn"><i class="fas fa-save"></i>Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const BASE=location.origin;

/* ===== sidebar mobile toggle ===== */
function toggleMenu(){document.getElementById('side').classList.toggle('open');document.querySelector('.overlay').classList.toggle('show');}

/* ===== modal helpers ===== */
function openModal(){document.getElementById('modal').style.display='flex';}
function closeModal(){document.getElementById('modal').style.display='none';document.getElementById('addrForm').reset();document.getElementById('modalMsg').innerHTML='';}

/* ===== utility ===== */
function showMsg(target,text,type='error'){
  document.querySelector(target).innerHTML=`<div class="note ${type==='success'?'success':'error'}">${text}</div>`;
}
function setLoading(btn,label){
  btn.disabled=true;
  btn.dataset.orig=btn.innerHTML;
  btn.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${label}`;
}
function clearLoading(btn){btn.disabled=false;btn.innerHTML=btn.dataset.orig;}

/* ===== fill form for add / edit ===== */
function fillForm(o={}){
  document.getElementById('modalTitle').textContent=o._id?'Edit address':'Add address';
  document.getElementById('methodField').value=o._id?'PUT':'POST';
  document.getElementById('addressId').value=o._id||'';
  const f=document.getElementById('addrForm');
  f.fullName.value=o.fullName||'';
  f.phone.value=o.phone||'';
  f.street.value=o.street||'';
  f.city.value=o.city||'';
  f.state.value=o.state||'';
  f.pincode.value=o.pincode||'';
  document.getElementById('isDefaultBox').checked=!!o.isDefault;
  if(o.type==='work')f.addressType.value='work';else f.addressType.value='home';
}

/* ===== open empty modal ===== */
document.getElementById('addBtn').onclick=()=>{fillForm();openModal();};

/* ===== edit buttons ===== */
document.querySelectorAll('.editBtn').forEach(b=>{
  b.onclick=e=>{
    e.preventDefault();
    fillForm(JSON.parse(b.dataset.json));
    openModal();
  };
});

/* ===== delete buttons ===== */
document.querySelectorAll('.deleteBtn').forEach(b=>{
  b.onclick=async e=>{
    e.preventDefault();
    if(!confirm('Delete this address?'))return;
    try{
      const res=await fetch(`${BASE}/user/profile/address/${b.dataset.id}/delete`,{method:'DELETE'});
      const out=await res.json();
      if(!res.ok)throw new Error(out.message);
      location.reload();
    }catch(err){showMsg('#pageNote',err.message);}
  };
});

/* ===== form submit ===== */
document.getElementById('addrForm').addEventListener('submit',async e=>{
  e.preventDefault();
  showMsg('#modalMsg','');
  const btn=document.getElementById('submitBtn');
  setLoading(btn,'Saving');
  const fd=new FormData(e.target);
  const data={};
  fd.forEach((v,k)=>{if(k!=='_method'&&k!=='addressId')data[k]=v;});
  if(fd.get('addressType')==='home')data.isHomeAddress=true;
  if(fd.get('addressType')==='work')data.isWorkAddress=true;
  const isEdit=fd.get('_method')==='PUT';
  const id=fd.get('addressId');
  const url=isEdit?`${BASE}/user/profile/address/${id}/edit`:`${BASE}/user/profile/address/add`;
  const method=isEdit?'PUT':'POST';

  try{
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const out=await r.json();
    if(!r.ok)throw new Error(out.message);
    showMsg('#pageNote',out.message||'Saved','success');
    closeModal();
    setTimeout(()=>location.reload(),800);
  }catch(err){
    showMsg('#modalMsg',err.message);
  }finally{clearLoading(btn);}
});

/* ===== close modal on outside click ===== */
document.getElementById('modal').addEventListener('click',e=>{
  if(e.target.id==='modal')closeModal();
});
</script>
</body>
</html>
