<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Addresses</title>

  <!-- 1.  Bootstrap & Font-Awesome CDN  -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- 2.  A touch of custom style (black text + tan accent)  -->
  <style>
    :root {
      --tan: #d2b48c;
    }
    body { font-family: Arial, sans-serif; }
    /* easy card shadow */
    .addr-card { border: 1px solid #eee; border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,.1); }
    .addr-card:hover { transform: translateY(-3px); transition: .2s; }
    .badge-default { background: var(--tan); color: #fff; }
    .modal-content {
        padding: 10px;
    }
  </style>
</head>
<body>



  <div class="container my-4">

    <!-- 3.  Title + â€œAddâ€ button  -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">My Address Book</h3>
      <!-- data-toggle opens the Bootstrap modal -->
      <button class="btn btn-dark btn-sm" data-toggle="modal" data-target="#addrModal" id="addBtn">
        <i class="fas fa-plus-circle"></i> Add
      </button>
    </div>

    <!-- 4.  Address list -->
    <div class="row">

      <% if (addresses.length) { %>
        <% addresses.forEach(addr => { %>
          <div class="col-md-6 mb-3">
            <div class="p-3 addr-card">

              <% if (addr.isDefault) { %>
                <span class="badge badge-default float-right">Default</span>
              <% } %>

              <h5><%= addr.fullName %></h5>
              <p class="mb-1"><%= addr.street %></p>
              <p class="mb-1"><%= addr.city %>, <%= addr.state %> â€“ <%= addr.zip %></p>
              <p class="mb-2">ðŸ“ž <%= addr.phone %></p>

              <!-- Edit / Delete icons -->
              <a href="#" class="text-info editBtn"              /* edit */
                 data-json='<%- JSON.stringify(addr) %>'>
                 <i class="fas fa-edit"></i>
              </a>
              <a href="/address/<%= addr._id %>/delete"          /* delete */
                 class="text-danger ml-2">
                 <i class="fas fa-trash-alt"></i>
              </a>

            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12 text-muted">You donâ€™t have any addresses yet.</div>
      <% } %>

    </div>
  </div>


  <div class="modal fade" id="addrModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addrForm" class="mt-5" >

          <div class="modal-header" style="background:var(--tan); color:#fff;">
            <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="methodField" name="_method" value="POST">

            <div class="form-group">
              <label>Full Name *</label>
              <input type="text" class="form-control" name="fullName" required>
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" class="form-control" name="phone" required>
            </div>
            <div class="form-group">
              <label>Street *</label>
              <input type="text" class="form-control" name="street" required>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>City *</label>
                <input type="text" class="form-control" name="city" required>
              </div>
              <div class="form-group col-md-6">
                <label>State *</label>
                <input type="text" class="form-control" name="state" required>
              </div>
            </div>
            <div class="form-group">
              <label>ZIP *</label>
              <input type="text" class="form-control" name="zip" required>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="isHomeAddress" id="isDefaultBox">
              <label class="form-check-label" for="isDefaultBox">
                Set as home address
              </label>
            </div>

            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="isWorkAddress" id="isWorkBox">
               <label class="form-check-label" for="isWorkBox">
                Set as work address
              </label>
            </div>

          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-dark btn-sm" type="submit">Save</button>
          </div>

        </form>
      </div>
    </div>
  </div>



  <script>
  const BASE_URL = window.location.origin;

  function fillForm(obj = {}) {
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('addrForm');
    const methodField = document.getElementById('methodField');

    const isEditing = !!obj._id;
    modalTitle.textContent = isEditing ? 'Edit Address' : 'Add Address';
    form.action = isEditing ? `/address/${obj._id}/edit` : '/address/add';
    methodField.value = isEditing ? 'PUT' : 'POST';

    form.fullName.value = obj.fullName || '';
    form.phone.value = obj.phone || '';
    form.street.value = obj.street || '';
    form.city.value = obj.city || '';
    form.state.value = obj.state || '';
    form.zip.value = obj.zip || '';
    form.isDefault.checked = !!obj.isDefault;
  }

  document.getElementById('addBtn').addEventListener('click', () => fillForm());

  document.querySelectorAll('.editBtn').forEach(button => {
    button.addEventListener('click', e => {
      e.preventDefault();
      const data = JSON.parse(button.dataset.json);
      fillForm(data);
      $('#addrModal').modal('show');
    });
  });

  const form = document.getElementById('addrForm');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const jsonData = {};
    formData.forEach((value, key) => {
      jsonData[key] = value;
    });

    const isEdit = form.methodField.value === 'PUT';
    const actionUrl = form.action;
    const method = isEdit ? 'PUT' : 'POST';

    try {
      const res = await fetch(`${actionUrl}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(jsonData)
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result.message || 'Something went wrong');
      alert('Address saved successfully!');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });
</script>


</body>
</html>
