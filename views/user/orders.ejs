<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Orders â€“ <%= user.name %></title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
  :root{
    --bg:#f7f9fc;--white:#fff;--primary:#000;--primary-light:#e8f0ff;
    --text:#374151;--muted:#6b7280;--radius:12px;--tr:.25s;
    --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#000;
  }




  /* mobile header */
  .mobile-top{display:none;background:var(--white);border-bottom:1px solid #e5e7eb;
              padding:1rem 1.25rem;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
  .mobile-btn{background:none;border:none;font-size:1.3rem}
  .overlay{display:none;position:fixed;inset:0;background:#0005;z-index:800}


    :root {
        --bg: #fafafa;
        --white: #ffffff;
        --primary: #111827;
        --muted: #6b7280;
        --accent: #000;
        --accent-dark: #000;
        --radius: 12px;
        --tr: 0.25s;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      .show {
        display: flex !important;
        opacity: 1;
      }

      /* ----------  Reset & globals  ---------- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: var(--bg);
        color: var(--primary);
        line-height: 1.45;
      }
      a {
        color: inherit;
      }

      /* ----------  Layout  ---------- */
      .profile-wrapper {
        display: flex;
        min-height: 100dvh;
        max-width: 1300px;
        margin: auto;
      }
      main.profile-main {
        flex: 1;
        padding: 2rem 2rem 4rem;
      }

      /* ----------  Sidebar  ---------- */
      .profile-sidebar {
        width: 290px;
        background: var(--white);
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        padding: 2rem 0;
        transition: transform var(--tr);
        z-index: 850;
      }
      .profile-sidebar-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0 20px;
        margin-bottom: 2rem;
      }

  .profile-avatar-mini {
    inline-size: 56px;
    block-size: 46px;
    border-radius: 50%;
    background: #dbeafe;
    display: grid;
    place-items: center;
    font-weight: 600;
    overflow: hidden;
  }


  .profile-avatar-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }


nav.profile-nav ul {
        list-style: none;
  }


      nav.profile-nav a {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        padding: 0.85rem 1.6rem;
        text-decoration: none;
        color: inherit;
        border-left: 3px solid transparent;
        transition: background var(--tr), color var(--tr);
      }

    
      nav.profile-nav a i {
        width: 18px;
        text-align: center;
        font-size: 0.9rem;
      }

      nav.profile-nav a:hover {
        background: #f3f4f6;
      }

      nav.profile-nav a.active {
        border-color: var(--accent);
        background: #eef4ff;
        color: var(--accent-dark);
        font-weight: 500;
      }


      .profile-logout {
        margin-top: auto;
        padding: 0.85rem 1.6rem;
        background: none;
        border: none;
        font: inherit;
        text-align: left;
        cursor: pointer;
        color: var(--muted);
      }

      .profile-logout i {
        margin-right: 0.5rem;
      }

      .profile-logout:hover {
        color: var(--accent-dark);
      }

      /* ----------  Mobile header  ---------- */
      .profile-mobile-top {
        display: none;
        position: sticky;
        top: 0;
        z-index: 1;
        background: var(--white);
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 1.25rem;
        align-items: center;
        justify-content: space-between;
      }
      .profile-burger {
        background: none;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
      }

      /* overlay */
      .profile-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: #0005;
        z-index: 800;
      }
      .profile-overlay.show {
        display: block;
      }

      /* ----------  Breadcrumb  ---------- */
      .profile-crumb {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 1.4rem !important;
      }

      .profile-crumb i {
        margin-inline: 0.25rem;
      }


  /* main */
  h1{font-size:1.4rem;margin-bottom:1.4rem}
  .crumb{font-size:.85rem;color:var(--muted);margin-bottom:1.2rem}
  .crumb i{margin-inline:.25rem}
  .orders-profile{ padding: 1rem 2rem; }

  /* page header */
  .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
  .page-stats{display:flex;gap:1.5rem;font-size:.9rem;color:var(--muted)}
  .stat-item{display:flex;align-items:center;gap:.4rem}

  /* filters & controls */
  .controls{background:var(--white);border:1px solid #e5e7eb;border-radius:var(--radius);
            padding:1.5rem;margin-bottom:1.5rem}
  .controls-row{display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end}
  .filter-group{display:flex;flex-direction:column;gap:.4rem;min-width:140px}
  .filter-label{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase}
  .filter-select,.search-input{
    padding:.7rem .9rem;border:1px solid #d1d5db;border-radius:8px;
        display: flex;
    justify-content: center;
    align-items: center;
                               font-size:.9rem;background:var(--white);transition:all var(--tr)}
  .filter-select:focus,.search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,110,253,.1)}
  .search-group{flex:1;min-width:250px}
  .search-box{position:relative}
  .search-input{width:100%;padding-left:2.8rem}
  .search-icon{position:absolute;right:1rem;top:50%;transform:translateY(-50%);color:var(--muted)}
  .reset-btn{padding:.7rem 1.2rem;background:#f8f9fa;border:1px solid #d1d5db;border-radius:8px;
             color:var(--text);cursor:pointer;font-size:.9rem;transition:all var(--tr);
             display:flex;align-items:center;gap:.5rem}
  .reset-btn:hover{background:#e9ecef;transform:translateY(-1px)}
  .apply-btn{padding:.7rem 1.2rem;background:var(--primary);border:1px solid var(--primary);border-radius:8px;
             color:var(--white);cursor:pointer;font-size:.9rem;transition:all var(--tr);
             display:flex;align-items:center;gap:.5rem}
  .apply-btn:hover{background:#0b5be0;transform:translateY(-1px)}

  /* results info */
  .results-info{background:var(--white);border:1px solid #e5e7eb;border-radius:var(--radius);
                padding:1rem 1.5rem;margin-bottom:1rem;display:flex;justify-content:space-between;
                align-items:center;font-size:.9rem}
  .results-text{color:var(--muted)}
  .results-count{font-weight:600;color:var(--text)}
  .sort-info{color:var(--muted)}

  /* orders list */
  .orders-container{background:var(--white);border:1px solid #e5e7eb;border-radius:var(--radius);overflow:hidden}
  .order-card{border-bottom:1px solid #f3f4f6;padding:1.5rem;transition:all var(--tr);position:relative}
  .order-card:hover{background:#fafbfc;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.05)}
  .order-card:last-child{border-bottom:none}
  
  .order-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
  .order-info h3{font-size:1rem;margin-bottom:.3rem;color:var(--text)}
  .order-id{font-family:monospace;color:var(--primary);font-weight:600}
  .order-meta{font-size:.85rem;color:var(--muted);display:flex;gap:1.5rem;flex-wrap:wrap}
  .meta-item{display:flex;align-items:center;gap:.4rem}
  .order-status{padding:.4rem .8rem;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase;
                display:flex;align-items:center;gap:.3rem}
  .status-pending{background:#fef3c7;color:#92400e}
  .status-confirmed{background:#dbeafe;color:#1e40af}
  .status-shipped{background:#e0e7ff;color:#3730a3}
  .status-delivered{background:#d1fae5;color:#065f46}
  .status-cancelled{background:#fee2e2;color:#991b1b}
  .status-returned{background:#f3e8ff;color:#6b21a8}

  .order-items{margin:1rem 0}
  .item-row{display:flex;align-items:center;gap:1rem;padding:.75rem 0;border-bottom:1px solid #f9fafb}
  .item-row:last-child{border-bottom:none}
  .item-image{width:50px;height:50px;border-radius:8px;object-fit:cover;background:#f3f4f6}
  .item-details{flex:1}
  .item-name{font-size:.9rem;font-weight:500;margin-bottom:.2rem}
  .item-variant{font-size:.8rem;color:var(--muted)}
  .item-price{font-weight:600;color:var(--text)}

  .order-footer{display:flex;justify-content:space-between;align-items:center;margin-top:1rem;
                padding-top:1rem;border-top:1px solid #f3f4f6}
  .order-total{font-size:1.1rem;font-weight:600;display:flex;flex-direction:column;gap:.2rem}
  .total-amount{color:var(--text)}
  .savings{font-size:.8rem;color:var(--success)}
  .order-actions{display:flex;gap:.75rem;flex-wrap:wrap}

  /* pagination */
  .pagination-container{background:var(--white);border:1px solid #e5e7eb;border-radius:var(--radius);
                        padding:1.5rem;margin-top:1.5rem}
  .pagination-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;
                   font-size:.9rem;color:var(--muted)}
  .pagination{display:flex;justify-content:center;align-items:center;gap:.5rem}
  .page-btn{padding:.6rem .9rem;border:1px solid #d1d5db;background:var(--white);color:var(--text);
            text-decoration:none;border-radius:8px;font-size:.9rem;transition:all var(--tr);
            display:flex;align-items:center;gap:.3rem}
  .page-btn:hover:not(.disabled){background:#f9fafb;transform:translateY(-1px); color: #000 !important;}
  .page-btn.active{background:var(--primary);color:var(--white);border-color:var(--primary)}
  .page-btn.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}
  .page-dots{padding:.6rem;color:var(--muted)}
  .page-input{width:60px;padding:.4rem .6rem;border:1px solid #d1d5db;border-radius:6px;
              text-align:center;font-size:.9rem}



  /* empty state */
  .empty-state{text-align:center;padding:4rem 2rem;color:var(--muted)}
  .empty-state i{font-size:4rem;margin-bottom:1.5rem;opacity:.3}
  .empty-state h3{margin-bottom:.8rem;color:var(--text);font-size:1.2rem}
  .empty-state p{margin-bottom:1.5rem;line-height:1.6}

  /* loading */
  .loading{display:none;text-align:center;padding:3rem;color:var(--muted)}
  .loading.show{display:block}
  .spinner{display:inline-block;width:24px;height:24px;border:3px solid #f3f3f3;
           border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

  /* active filters */
  .active-filters{display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap}
  .filter-tag{background:var(--primary-light);color:var(--primary);padding:.3rem .7rem;
              border-radius:20px;font-size:.8rem;display:flex;align-items:center;gap:.4rem}
  .filter-tag button{background:none;border:none;color:inherit;cursor:pointer;font-size:1rem}

  /* responsive */
  @media(max-width:768px){
    .sidebar{position:fixed;inset:0 50% 0 0;transform:translateX(-100%);z-index:850}
    .sidebar.open{transform:none}
    .mobile-top{display:flex}
    .wrapper{flex-direction:column}
    .overlay.show{display:block}
    
    .page-header{flex-direction:column;gap:1rem;align-items:stretch}
    .page-stats{justify-content:center}
    .controls-row{flex-direction:column;align-items:stretch}
    .filter-group,.search-group{min-width:auto}
    .results-info{flex-direction:column;gap:.5rem;text-align:center}
    .order-header{flex-direction:column;gap:.75rem}
    .order-meta{flex-direction:column;gap:.3rem}
    .order-footer{flex-direction:column;gap:1rem;align-items:stretch}
    .order-actions{justify-content:center}
    .item-row{flex-wrap:wrap}
    .pagination{flex-wrap:wrap}
    .pagination-info{flex-direction:column;gap:.5rem;text-align:center}
  }

  @media(max-width:480px){
    .item-row{flex-direction:column;text-align:center;gap:.5rem}
    .order-actions{flex-direction:column}
    .page-stats{flex-direction:column;gap:.5rem}
  }


        @media (max-width: 968px) {
        .profile-wrapper {
          flex-direction: column;
        }
        main.profile-main {
          padding: 1.5rem 1.25rem 4rem;
        }
        .profile-sidebar {
          position: fixed;
          inset: 0 50% 0 0;
          transform: translateX(-100%);
          box-shadow: var(--shadow-lg);
        }
        .profile-sidebar.open {
          transform: translateX(0);
        }
        .profile-mobile-top {
          display: flex;
        }
      }

      
  </style>
</head>
<body>

<!-- mobile header -->

 <header class="profile-mobile-top">
      <button
        class="profile-burger"
        aria-label="Toggle navigation"
        onclick="toggleMenu()"
      >
        <i class="fas fa-bars"></i>
      </button>
      <span>My Orders</span>
      <span></span>
    </header>



    <!-- overlay -->
    <div class="profile-overlay" onclick="toggleMenu()"></div>

    <div class="profile-wrapper">
      <!-- Sidebar -->
      <aside class="profile-sidebar" id="side">
        <div class="profile-sidebar-header">


                  <div class="profile-avatar-mini">
            <% if(user.profileImage){ %>
            <img src="<%= user.profileImage %>" alt="profile" />
            <% }else{ %> <%= user.name[0].toUpperCase() %> <% } %>
          </div>


          <div>
            <strong><%= user.name %></strong><br />
            <span style="font-size: 0.78rem; color: var(--muted)"
              ><%= user.email %></span
            >
          </div>
        </div>

        <nav class="profile-nav">
          <ul>
                     <li><a href="/user/profile" ><i class="fas fa-user"></i>Personal data</a></li>
          <li><a href="/user/profile/address" ><i class="fas fa-map-marker-alt"></i>Addresses</a></li>
          <li><a href="/user/profile/orders" class="active"><i class="fas fa-box"></i>Orders</a></li>
          <li><a href="/user/profile/wallet"><i class="fas fa-wallet"></i>Wallet</a></li>
          <li><a href="/contact-us"><i class="fas fa-phone"></i>Contact us</a></li>
          </ul>
        </nav>

        <button class="profile-logout" onclick="location.href='/logout'">
          <i class="fas fa-sign-out-alt"></i>Log out
        </button>
      </aside>



<div class="wrapper">

  <!-- main -->
  <main class="orders-profile">
    <div class="crumb"><i class="fas fa-house"></i> Home â€º Account â€º Orders</div>
    
    <div class="page-header">
      <h1>My Orders</h1>
      <div class="page-stats">
        <div class="stat-item">
          <i class="fas fa-box"></i>
          <span><%= totalOrders %> Total Orders</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-clock"></i>
          <span><%= pendingOrders || 0 %> Pending</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-check-circle"></i>
          <span><%= deliveredOrders || 0 %> Delivered</span>
        </div>
      </div>
    </div>

    <!-- filters & controls -->
    <div class="controls">
      <div class="controls-row">
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-select" id="status-filter">
            <option value="">All Orders</option>
            <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>Pending</option>
            <option value="confirmed" <%= filters.status === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
            <option value="shipped" <%= filters.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
            <option value="delivered" <%= filters.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
            <option value="cancelled" <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
            <option value="returned" <%= filters.status === 'returned' ? 'selected' : '' %>>Returned</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <select class="filter-select" id="date-filter">
            <option value="">All Time</option>
            <option value="7" <%= filters.dateRange === '7' ? 'selected' : '' %>>Last 7 days</option>
            <option value="30" <%= filters.dateRange === '30' ? 'selected' : '' %>>Last 30 days</option>
            <option value="90" <%= filters.dateRange === '90' ? 'selected' : '' %>>Last 3 months</option>
            <option value="365" <%= filters.dateRange === '365' ? 'selected' : '' %>>Last year</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Payment Method</label>
          <select class="filter-select" id="payment-filter">
            <option value="">All Methods</option>
            <option value="cod" <%= filters.paymentMethod === 'cod' ? 'selected' : '' %>>Cash on Delivery</option>
            <option value="online" <%= filters.paymentMethod === 'online' ? 'selected' : '' %>>Online Payment</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Sort by</label>
          <select class="filter-select" id="sort-filter">
            <option value="createdAt_desc" <%= filters.sortBy === 'createdAt_desc' ? 'selected' : '' %>>Newest first</option>
            <option value="createdAt_asc" <%= filters.sortBy === 'createdAt_asc' ? 'selected' : '' %>>Oldest first</option>
            <option value="totalAmount_desc" <%= filters.sortBy === 'totalAmount_desc' ? 'selected' : '' %>>Highest amount</option>
            <option value="totalAmount_asc" <%= filters.sortBy === 'totalAmount_asc' ? 'selected' : '' %>>Lowest amount</option>
          </select>
        </div>

        <div class="search-group">
          <label class="filter-label">Search Orders</label>
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input style="padding: 10px;" type="text" class="search-input" id="search-input" 
                   placeholder="Search by order ID" 
                   value="<%= filters.search || '' %>">
          </div>
        </div>

        <button class="apply-btn" onclick="applyFilters()">
          <i class="fas fa-filter"></i> Apply
        </button>

        <button class="reset-btn" onclick="resetFilters()">
          <i class="fas fa-refresh"></i> Reset
        </button>
      </div>

      <!-- Active filters -->
      <div class="active-filters" id="active-filters">
        <% if (filters.status) { %>
          <div class="filter-tag">
            Status: <%= filters.status %>
            <button onclick="removeFilter('status')"><i class="fas fa-times"></i></button>
          </div>
        <% } %>
        <% if (filters.dateRange) { %>
          <div class="filter-tag">
            Date: Last <%= filters.dateRange %> days
            <button onclick="removeFilter('dateRange')"><i class="fas fa-times"></i></button>
          </div>
        <% } %>
        <% if (filters.paymentMethod) { %>
          <div class="filter-tag">
            Payment: <%= filters.paymentMethod.toUpperCase() %>
            <button onclick="removeFilter('paymentMethod')"><i class="fas fa-times"></i></button>
          </div>
        <% } %>
        <% if (filters.search) { %>
          <div class="filter-tag">
            Search: "<%= filters.search %>"
            <button onclick="removeFilter('search')"><i class="fas fa-times"></i></button>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Results info -->
    <div class="results-info">
      <div class="results-text">
        Showing <span class="results-count"><%= startIndex %>-<%= endIndex %></span> 
        of <span class="results-count"><%= totalOrders %></span> orders
      </div>
      <div class="sort-info">
        <% if (filters.sortBy) { %>
          <% 
            const sortLabels = {
              'createdAt_desc': 'Newest first',
              'createdAt_asc': 'Oldest first', 
              'totalAmount_desc': 'Highest amount',
              'totalAmount_asc': 'Lowest amount'
            };
          %>
          Sorted by: <%= sortLabels[filters.sortBy] || filters.sortBy %>
        <% } else { %>
          Sorted by: Newest first
        <% } %>
      </div>
    </div>

    <!-- loading state -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Loading orders...</p>
    </div>

    <!-- orders list -->
    <div class="orders-container" id="orders-container">
      <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => { %>
          <div class="order-card mt-3">
            <div class="order-header">
              <div class="order-info">
                <h3>
                  Order <span class="order-id">#<%= order.orderNumber || order._id.toString().slice(-8) %></span>
                </h3>
                <div class="order-meta">
                  <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span><%= new Date(order.createdAt).toLocaleDateString('en-US', { 
                      year: 'numeric', month: 'short', day: 'numeric' 
                    }) %></span>
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-box"></i>
                    <span><%= order.items.length %> item<%= order.items.length > 1 ? 's' : '' %></span>
                  </div>
                  <div class="meta-item">
                    <i class="fas fa-<%= order.paymentMethod === 'cod' ? 'money-bill-wave' : 'credit-card' %>"></i>
                    <span><%= order.paymentMethod.toUpperCase() %></span>
                  </div>
                </div>
              </div>
              <div class="order-status font-bold status-<%= order.orderStatus %>">
                <%= order.orderStatus %>
              </div>
            </div>

            <div class="order-items">
              <% order.items.slice(0, 3).forEach(item => { %>
                <div class="item-row">
                  <img src="<%= item.productImage || '/placeholder.svg?height=50&width=50' %>" 
                       alt="<%= item.productName %>" class="item-image">
                  <div class="item-details">
                    <div class="item-name"><%= item.productName %></div>
                    <div class="item-variant">
                      <%= item.variant.color %> â€¢ <%= item.variant.size.toUpperCase() %> â€¢ Qty: <%= item.quantity %>
                    </div>
                  </div>
                  <div class="item-price">â‚¹<%= (item.price * item.quantity).toFixed(2) %></div>
                </div>
              <% }) %>
              <% if (order.items.length > 3) { %>
                <div class="item-row">
                  <div style="color:var(--muted);font-size:.9rem;text-align:center;width:100%;padding:.5rem">
                    <i class="fas fa-plus"></i> <%= order.items.length - 3 %> more item<%= order.items.length - 3 > 1 ? 's' : '' %>
                  </div>
                </div>
              <% } %>
            </div>

            <div class="order-footer">
              <div class="order-total">
                <div class="total-amount">Total: â‚¹<%= order.totalAmount.toFixed(2) %></div>
                <% if (order.coupon && order.coupon.discountAmount > 0) { %>
                  <div class="savings">
                    <i class="fas fa-tag"></i> You saved â‚¹<%= order.coupon.discountAmount.toFixed(2) %>
                  </div>
                <% } %>
              </div>
              <div class="order-actions">
                <a style="font-size: 14px !important;" href="/user/profile/orders/<%= order._id %>" class="action-btn px-2 py-2">
                 View Details
                </a>
              </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="empty-state">
          <i class="fas fa-box-open"></i>
          <h3>No orders found</h3>
          <p>
            <% if (Object.values(filters).some(f => f)) { %>
              No orders match your current filters. Try adjusting your search criteria.
            <% } else { %>
              You haven't placed any orders yet. Start shopping to see your orders here.
            <% } %>
          </p>
          <% if (Object.values(filters).some(f => f)) { %>
            <button class="action-btn text-align-center ml-auto mr-auto mt-2" onclick="resetFilters()">
               Clear All Filters
            </button>
          <% } else { %>
            <a href="/user/products/shop" class="action-btn primary">
              <i class="fas fa-shopping-cart"></i> Start Shopping
            </a>
          <% } %>
        </div>
      <% } %>
    </div>

    <!-- pagination -->
<% if (totalPages > 1) { %>
  <div class="pagination-container">
    <div class="pagination-info">
      Page <%= currentPage %> of <%= totalPages %> (<%= totalOrders %> total orders)
    </div>
    <div class="pagination">
      <% if (currentPage > 1) { %>
        <a href="<%= buildUrl({page: 1}) %>" class="page-btn">
          <i class="fas fa-angle-double-left"></i> First
        </a>
        <a href="<%= buildUrl({page: currentPage - 1}) %>" class="page-btn">
          <i class="fas fa-chevron-left"></i> Previous
        </a>
      <% } else { %>
        <span class="page-btn disabled"><i class="fas fa-chevron-left"></i> Previous</span>
      <% } %>
      
      <% 
        let startPage = Math.max(1, currentPage - 2);
        let endPage   = Math.min(totalPages, currentPage + 2);

        // keep 5 numbers visible
        if (endPage - startPage < 4) {
          if (startPage === 1) endPage = Math.min(totalPages, startPage + 4);
          else if (endPage === totalPages) startPage = Math.max(1, endPage - 4);
        }
      %>
      <% if (startPage > 1) { %>
        <a href="<%= buildUrl({page: 1}) %>" class="page-btn">1</a>
        <% if (startPage > 2) { %>
          <span class="page-dots">...</span>
        <% } %>
      <% } %>

      <% for(let i = startPage; i <= endPage; i++) { %>
        <a href="<%= buildUrl({page: i}) %>" class="page-btn <%= i === currentPage ? 'active' : '' %>">
          <%= i %>
        </a>
      <% } %>

      <% if (endPage < totalPages) { %>
        <% if (endPage < totalPages - 1) { %>
          <span class="page-dots">...</span>
        <% } %>
        <a href="<%= buildUrl({page: totalPages}) %>" class="page-btn"><%= totalPages %></a>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <a href="<%= buildUrl({page: currentPage + 1}) %>" class="page-btn">Next <i class="fas fa-chevron-right"></i></a>
        <a href="<%= buildUrl({page: totalPages}) %>" class="page-btn">Last <i class="fas fa-angle-double-right"></i></a>
      <% } else { %>
        <span class="page-btn disabled">Next <i class="fas fa-chevron-right"></i></span>
      <% } %>
    </div>
  </div>
<% } %>

  </main>
</div>

<script>
const filters = {
  status: '',
  dateRange: '',
  paymentMethod: '',
  sortBy: 'createdAt_desc',
  search: '',
  page: 1
};

function serializeFilters(custom = {}) {
  const merged = {...filters, ...custom};
  const params = new URLSearchParams();
  Object.keys(merged).forEach(key => {
    if (merged[key]) params.set(key, merged[key]);
  });
  return params.toString();
}

// --- Fetch and Render Orders ---
async function fetchAndRenderOrders(custom = {}) {
  // Update global filters object
  Object.assign(filters, custom);

  // Update UI
  document.getElementById('loading').classList.add('show');
  document.getElementById('orders-container').style.opacity = '0.5';

  try {
    const url = '/user/profile/orders/api/filtered/all?' + serializeFilters();
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch orders');
    const data = await res.json();

    // Build and update orders/pagination/template
    document.getElementById('orders-container').innerHTML = renderOrders(data.orders);
    document.querySelector('.results-info').innerHTML = renderResultsInfo(data);
    if (document.querySelector('.pagination-container')) {
      document.querySelector('.pagination-container').innerHTML = renderPagination(data);
    }

    // Optionally update stats, filters, etc.
    if (document.querySelector('.page-stats')) {
      document.querySelector('.page-stats').innerHTML = renderStats(data);
    }
  } catch (err) {
    document.getElementById('orders-container').innerHTML =
      `<div class="empty-state"><i class="fas fa-box-open"></i><h3>Error</h3><p>${err.message}</p></div>`;
  } finally {
    document.getElementById('loading').classList.remove('show');
    document.getElementById('orders-container').style.opacity = '1';
  }
}

function renderOrders(orders) {
  if (!orders || !orders.length) return `
    <div class="empty-state"><i class="fas fa-box-open"></i>
      <h3>No orders found</h3><p>No orders match your current filters.</p>
    </div>`;
  return orders.map(order => /*html*/`
    <div class="order-card mt-3">
      <div class="order-header">
        <div class="order-info">
          <h3>
            Order <span class="order-id">#${order.orderNumber || order._id.slice(-8)}</span>
          </h3>
          <div class="order-meta">
            <div class="meta-item">
              <i class="fas fa-calendar"></i>
              <span>${new Date(order.createdAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
              })}</span>
            </div>
            <div class="meta-item"><i class="fas fa-box"></i>
              <span>${order.items.length} item${order.items.length > 1 ? 's' : ''}</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-${order.paymentMethod === 'cod' ? 'money-bill-wave' : 'credit-card'}"></i>
              <span>${order.paymentMethod.toUpperCase()}</span>
            </div>
          </div>
        </div>
        <div class="order-status status-${order.orderStatus}">

          ${order.orderStatus}
        </div>
      </div>
      <div class="order-items">
        ${order.items.slice(0, 3).map(item => `
          <div class="item-row">
            <img src="${item.productImage || '/placeholder.svg?height=50&width=50'}"
            class="item-image" alt="${item.productName}">
            <div class="item-details"><div class="item-name">${item.productName}</div>
            <div class="item-variant">
              ${item.variant.color} â€¢ ${item.variant.size.toUpperCase()} â€¢ Qty: ${item.quantity}
            </div></div>
            <div class="item-price">â‚¹${(item.price * item.quantity).toFixed(2)}</div>
          </div>
        `).join('')}
        ${order.items.length > 3
          ? `<div class="item-row"><div style="color:var(--muted);font-size:.9rem;text-align:center;width:100%;padding:.5rem">
              <i class="fas fa-plus"></i> ${order.items.length - 3} more item${order.items.length - 3 > 1 ? 's' : ''}
            </div></div>`
          : ''}
      </div>
      <div class="order-footer">
        <div class="order-total">
          <div class="total-amount">Total: â‚¹${order.totalAmount.toFixed(2)}</div>
          ${order.coupon && order.coupon.discountAmount > 0
            ? `<div class="savings"><i class="fas fa-tag"></i> You saved â‚¹${order.coupon.discountAmount.toFixed(2)}</div>` : ''}
        </div>
        <div class="order-actions">
          <a href="/user/profile/orders/${order._id}" class="action-btn px-2 py-2" style="font-size:14px">View Details</a>
        </div>
      </div>
    </div>
  `).join('');
}


function renderResultsInfo(data) {
  return `
    <div class="results-text">
      Showing <span class="results-count">${data.startIndex}-${data.endIndex}</span> 
      of <span class="results-count">${data.totalOrders}</span> orders
    </div>
    <div class="sort-info">
      Sorted by: ${(function(sort) {
        return ({
          "createdAt_desc":"Newest first",
          "createdAt_asc":"Oldest first",
          "totalAmount_desc":"Highest amount",
          "totalAmount_asc":"Lowest amount"
        })[sort] || "Newest first";
      })(filters.sortBy)}
    </div>
  `;
}

function renderPagination(data) {
  let html = `<div class="pagination-info">
      <div>Page ${data.currentPage} of ${data.totalPages} (${data.totalOrders} total orders)</div>
    </div>
    <div class="pagination">`;
  if (data.currentPage > 1) {
    html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:1});return false;">
                <i class="fas fa-angle-double-left"></i>First</a>`;
    html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:${data.currentPage-1}});return false;">
                <i class="fas fa-chevron-left"></i> Previous</a>`;
  } else {
    html += `<span class="page-btn disabled"><i class="fas fa-chevron-left"></i> Previous</span>`;
  }

  const startPage = Math.max(1, data.currentPage - 2);
  const endPage = Math.min(data.totalPages, data.currentPage + 2);

  if (startPage > 1) html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:1});return false;">1</a>`;
  if (startPage > 2) html += `<span class="page-dots">...</span>`;

  for(let i=startPage; i<=endPage; i++) {
    html += `<a href="#" class="page-btn${i===data.currentPage?' active':''}" onclick="fetchAndRenderOrders({page:${i}});return false;">${i}</a>`;
  }

  if (endPage < data.totalPages - 1) html += `<span class="page-dots">...</span>`;
  if (endPage < data.totalPages) html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:${data.totalPages}});return false;">${data.totalPages}</a>`;
  
  if (data.currentPage < data.totalPages) {
    html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:${data.currentPage+1}});return false;">
                Next <i class="fas fa-chevron-right"></i></a>`;
    html += `<a href="#" class="page-btn" onclick="fetchAndRenderOrders({page:${data.totalPages}});return false;">
                Last <i class="fas fa-angle-double-right"></i></a>`;
  } else {
    html += `<span class="page-btn disabled">Next <i class="fas fa-chevron-right"></i></span>`;
  }
  html += `</div>`;
  return html;
}

function renderStats(data) {
  return `
    <div class="stat-item">
      <i class="fas fa-box"></i>
      <span>${data.totalOrders} Total Orders</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-clock"></i>
      <span>${data.pendingOrders || 0} Pending</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-check-circle"></i>
      <span>${data.deliveredOrders || 0} Delivered</span>
    </div>
  `;
}


document.getElementById('status-filter').onchange = function() {
  fetchAndRenderOrders({status: this.value, page: 1});
};
document.getElementById('date-filter').onchange = function() {
  fetchAndRenderOrders({dateRange: this.value, page: 1});
};
document.getElementById('payment-filter').onchange = function() {
  fetchAndRenderOrders({paymentMethod: this.value, page: 1});
};
document.getElementById('sort-filter').onchange = function() {
  fetchAndRenderOrders({sortBy:this.value});
};
document.getElementById('search-input').oninput = function() {
  clearTimeout(window._osrch);
  window._osrch = setTimeout(() => {
    fetchAndRenderOrders({search: this.value, page: 1});
  }, 700);
};
document.querySelector('.apply-btn').onclick = function() {
  fetchAndRenderOrders();
};
document.querySelector('.reset-btn').onclick = function() {
  fetchAndRenderOrders({status:'',dateRange:'',paymentMethod:'',sortBy:'createdAt_desc',search:'',page:1});
};

      function toggleMenu() {
        document.getElementById("side").classList.toggle("open");
        document.querySelector(".profile-overlay").classList.toggle("show");
      }


</script>


<%

function buildUrl(params) {
  const url = new URL(req.originalUrl, `${req.protocol}://${req.get('host')}`);
  Object.keys(params).forEach(key => {
    if (params[key]) {
      url.searchParams.set(key, params[key]);
    } else {
      url.searchParams.delete(key);
    }
  });
  return url.pathname + url.search;
}
%>






</body>
</html>
