<!-- views/user/profile/change-password.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Change password – <%= user.name %></title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
  :root{
    --bg:#f7f9fc;
    --white:#fff;
    --primary:#0d6efd;
    --primary-light:#e8f0ff;
    --text:#374151;
    --muted:#6b7280;
    --radius:12px;
    --tr:.25s;
  }
  *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
  body{background:var(--bg);color:var(--text);line-height:1.5;}

  /* ===== layout ===== */
  .wrapper{display:flex;min-height:100dvh;max-width:1300px;margin:auto;}

  /* ===== sidebar ===== */
  .sidebar{
    width:250px;background:var(--white);border-right:1px solid #e5e7eb;
    display:flex;flex-direction:column;padding:1.5rem 0;transition:transform var(--tr)
  }
  .avatar-box{display:flex;align-items:center;gap:.9rem;padding-inline:1.5rem;margin-bottom:1.75rem}
  .avatar{
    width:54px;height:54px;border-radius:50%;background:var(--primary-light);
    display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--primary);font-weight:600
  }
  .avatar-box p{font-size:.8rem;color:var(--muted)}
  nav ul{list-style:none}
  nav li a{
    display:flex;align-items:center;gap:.8rem;padding:.9rem 1.5rem;text-decoration:none;color:inherit;
    border-left:3px solid transparent;transition:background var(--tr),transform var(--tr)
  }
  nav li a:hover{background:#f1f5f9;transform:translateX(3px)}
  nav li a.active{border-color:var(--primary);background:var(--primary-light)}
  nav li i{width:18px;text-align:center}
  .logout{
    margin-top:auto;padding:.9rem 1.5rem;background:none;border:none;color:#ef4444;
    display:flex;gap:.6rem;cursor:pointer;transition:background var(--tr)
  }
  .logout:hover{background:#fee2e2}

  /* ===== mobile header ===== */
  .mobile-top{
    display:none;align-items:center;justify-content:space-between;background:var(--white);
    border-bottom:1px solid #e5e7eb;padding:1rem 1.25rem;position:sticky;top:0;
  }
  .mobile-btn{background:none;border:none;font-size:1.3rem}
  .overlay{display:none;position:fixed;inset:0;background:#0005;z-index:800}

  /* ===== main ===== */
  main{flex:1;padding:2rem 2.5rem;overflow-x:hidden}
  h1{font-size:1.4rem;margin-bottom:1.6rem}
  .crumb{font-size:.85rem;color:var(--muted);margin-bottom:1.2rem}
  .crumb i{margin-inline:.25rem}

  /* ===== form ===== */
  form{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .form-group{display:flex;flex-direction:column;gap:.35rem}
  label{font-size:.78rem;font-weight:600;color:var(--muted)}
  .input-box{
    display:flex;align-items:center;gap:.75rem;background:var(--white);
    border:1px solid #d1d5db;border-radius:var(--radius);padding:.7rem 1rem;
    transition:border-color var(--tr),box-shadow var(--tr)
  }
  .input-box:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,110,253,.15)}
  .input-box i{color:var(--muted)}
  .input-box input{
    border:none;background:none;outline:none;font-size:.95rem;color:var(--text);flex:1
  }

  .save-btn{
    justify-self:start;padding:.7rem 1.4rem;font-size:.9rem;display:inline-flex;align-items:center;gap:.6rem;
    background:var(--primary);color:var(--white);border:none;border-radius:var(--radius);cursor:pointer;
    transition:background var(--tr),transform var(--tr)
  }
  .save-btn[disabled]{opacity:.6;cursor:not-allowed}
  .save-btn:hover:not([disabled]){background:#0b5be0;transform:translateY(-2px)}

  /* ===== notifications ===== */
  .note{grid-column:1/-1;padding:.8rem 1.1rem;border-left:4px solid;border-radius:var(--radius);font-size:.9rem}
  .note.error{background:#fef2f2;border-color:#ef4444;color:#991b1b}
  .note.success{background:#f0fdf4;border-color:#22c55e;color:#166534}

  /* ===== responsiveness ===== */
  @media(max-width:768px){
    .sidebar{position:fixed;inset-block:0;left:0;z-index:850;transform:translateX(-100%)}
    .sidebar.open{transform:none}
    .mobile-top{display:flex}
    .wrapper{flex-direction:column}
    main{padding:1.25rem;margin-top:64px}
    .overlay.show{display:block}
  }
  </style>
</head>
<body>

<!-- ===== mobile header ===== -->
<div class="mobile-top">
  <button class="mobile-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
  <span>Change password</span>
  <span></span>
</div>
<div class="overlay" onclick="toggleMenu()"></div>

<div class="wrapper">
  <!-- ===== sidebar ===== -->
  <aside class="sidebar" id="side">
    <div class="avatar-box">
      <div class="avatar"><%= user.name?.[0].toUpperCase() ?? 'U' %></div>
      <div>
        <h4 style="font-size:1rem"><%= user.name %></h4>
        <p><%= user.email %></p>
      </div>
    </div>

    <nav>
      <ul>
        <li><a href="/user/profile/"><i class="fas fa-user"></i>Personal data</a></li>
        <li><a href="/user/profile/edit"><i class="fas fa-user-edit"></i>Edit profile</a></li>
        <li><a href="/user/profile/address"><i class="fas fa-map-marker-alt"></i>Addresses</a></li>
        <li><a class="active" href="/user/profile/password"><i class="fas fa-key"></i>Change password</a></li>
      </ul>
    </nav>

    <button class="logout" onclick="location.href='/logout'"><i class="fas fa-right-from-bracket"></i>Log out</button>
  </aside>

  <!-- ===== main ===== -->
  <main>
    <div class="crumb">
      <i class="fas fa-house"></i> Home <i class="fas fa-angle-right"></i> Account <i class="fas fa-angle-right"></i> Change password
    </div>
    <h1>Change password</h1>

    <!-- feedback placeholder -->
    <div id="formMessage"></div>

    <form id="passwordFormId">
      <% if(!googleAuth){ %>
      <div class="form-group" style="grid-column:1/-1">
        <label for="current">Current password</label>
        <div class="input-box">
          <i class="fas fa-lock"></i>
          <input id="current" name="currentPassword" type="password" required>
        </div>
      </div>
      <% } %>

      <div class="form-group">
        <label for="new">New password</label>
        <div class="input-box">
          <i class="fas fa-lock-open"></i>
          <input id="new" name="newPassword" type="password" required minlength="8">
        </div>
      </div>

      <div class="form-group">
        <label for="confirm">Confirm new password</label>
        <div class="input-box">
          <i class="fas fa-check-double"></i>
          <input id="confirm" name="confirmPassword" type="password" required minlength="8">
        </div>
      </div>

      <button id="saveBtn" class="save-btn" type="submit"><i class="fas fa-save"></i> Change</button>
    </form>
  </main>
</div>

<script>
/* ===== helpers ===== */
function toggleMenu(){
  document.getElementById('side').classList.toggle('open');
  document.querySelector('.overlay').classList.toggle('show');
}


function showMessage(text,type='error'){
  document.getElementById('formMessage').innerHTML=
    `<div class="note ${type==='success'?'success':'error'}">${text}</div>`;
}


function setLoading(btnId,label){
  const btn=document.getElementById(btnId);
  btn.disabled=true;
  btn.dataset.original=btn.innerHTML;
  btn.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${label}`;
}


function clearLoading(btnId){
  const btn=document.getElementById(btnId);
  btn.disabled=false;
  btn.innerHTML=btn.dataset.original;
}




const form = document.getElementById('passwordFormId');

console.log(form);


form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  e.stopPropagation();
  showMessage('');
  const newPwd=document.getElementById('new').value.trim();
  const confirm=document.getElementById('confirm').value.trim();

  if(!checkPasswordValid(newPwd)){
    showMessage('Invalid password. Must be ≥8 chars & include letters, numbers & a special character');
    return;
  }

  if(!checkPasswordMatch(newPwd,confirm)){
    showMessage('Passwords do not match');
    return;
  }

  setLoading('saveBtn','Changing');
  const payload={
    newPassword:newPwd,
    confirmPassword:confirm
  };


const currentPwdInput = document.getElementById('current');
if (currentPwdInput) {
  payload.currentPassword = currentPwdInput.value;
}


  try{

    const response = await fetch('/user/profile/api/change-password',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if(!response.ok) return showMessage(result.message||'Request failed');

    showMessage('Password changed successfully','success');
    window.location.reload();

   }catch(err){
    showMessage(err.message || 'Request failed');
   }finally{
    clearLoading('saveBtn');
   }

});



</script>
</body>
</html>
