<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shop</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha512-Fo3rlrZj/k7ujTU5q+8AX/7VZ9jWf+6sYQeCjg3ORNCQ4+ZUd1Po0i7zHjp5/4mE4aZQGHy3MjzhDl3vLeL0jw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Reset & base */
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; color: #333; line-height: 1.5; }
    a { color: inherit; text-decoration: none; }

    /* Utility */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    .row { display: flex; flex-wrap: wrap; margin: -0.5rem; }
    .col { padding: 0.5rem; }
    .col-3 { width: 25%; }
    .col-9 { width: 75%; }
    @media (max-width: 768px) { .col-3, .col-9 { width: 100%; } }

    /* Breadcrumb */
    .breadcrumb { background: #fff; padding: 1rem 0; margin-bottom: 1rem; }
    .breadcrumb a { color: #007bff; }
    .breadcrumb span { color: #6c757d; }

    /* Search & horizontal filters */
    .shop-filters { background: #fff; padding: 1rem 0; margin-bottom: 1rem; border-bottom: 1px solid #ddd; }
    .search-box { position: relative; max-width: 300px; margin-bottom: 0.75rem; }
    .search-box input { width: 100%; padding: 0.5rem 2.5rem 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; }
    .search-box button { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); border: none; background: none; font-size: 1rem; color: #555; }
    .filter-dropdown { display: inline-block; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .filter-dropdown select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }

    /* Sidebar */
    .desktop-sidebar { display: block; }
    .sidebar-filters { background: #fff; padding: 1rem; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .filter-group { margin-bottom: 1rem; }
    .filter-title { font-weight: 600; margin-bottom: 0.5rem; }
    .price-range, .size-options, .rating-options { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .price-range label, .size-options a, .rating-options a { cursor: pointer; }
    .size-options a, .rating-options a { padding: 0.25rem 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; }
    .size-options a.active, .rating-options a.active { background: #dc3545; color: #fff; border-color: #dc3545; }

    /* Mobile filter */
    .mobile-filter-btn { display: none; background: #dc3545; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-bottom: 1rem; }
    .mobile-filter-overlay { display: none; position: fixed; inset:0; background: rgba(0,0,0,0.5); }
    .mobile-filter-sidebar { position: fixed; top:0; left:-280px; width: 280px; height:100%; background: #fff; padding:1rem; overflow-y:auto; transition:left .3s ease; box-shadow:2px 0 6px rgba(0,0,0,0.2); }
    .mobile-filter-sidebar.active { left:0; }
    .close-mobile-filter { background:none; border:none; font-size:1.5rem; float:right; }

    /* Sort & results info */
    .sort-controls { display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; margin:1rem 0; }
    .results-info { font-size:0.9rem; }
    .sort-dropdown select { padding:0.5rem; border:1px solid #ccc; border-radius:4px; }

    /* Products grid */
    .products-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:1rem; }
    .product-item { background:#fff; border-radius:4px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.1); cursor:pointer; transition:transform .2s; }
    .product-item:hover { transform:translateY(-2px); }
    .product-item img { width:100%; height:200px; object-fit:cover; }
    .product-details { padding:0.75rem; }
    .product-details h6 { margin:0 0 .5rem; font-size:1rem; }
    .price-info { font-size:0.9rem; }
    .regular-price { color:#6c757d; text-decoration: line-through; margin-left:0.5rem; }
    .sale-price { color:#dc3545; font-weight:600; }

    /* Pagination */
    .pagination-wrapper { display:flex; justify-content:center; margin:2rem 0; }
    .pagination { display:flex; list-style:none; padding:0; gap:0.25rem; }
    .pagination li a { display:block; padding:0.5rem .75rem; border:1px solid #ccc; border-radius:4px; color:#333; }
    .pagination li.active a { background:#dc3545; color:#fff; border-color:#dc3545; }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .filter-dropdown, .search-box { width:100%; }
      .mobile-filter-btn { display:block; }
      .desktop-sidebar { display:none; }
    }
  </style>
</head>
<body>

  <!-- Breadcrumb -->
  <nav class="breadcrumb container">
    <a href="/">Home</a> &rsaquo;
    <span>Shop</span>
  </nav>

  <!-- Horizontal Search & Filters -->
  <section class="shop-filters container">
    <div class="search-box">
      <form method="GET" action="/user/products/shop">
        <input type="text" name="search" placeholder="Search products..."
               value="<%= search || '' %>">
        <button type="submit"><i class="fas fa-search"></i></button>
        <% [ 'category','brand','priceRange','size','color','rating','sortBy','page' ].forEach(f => {
             if (locals[f]) { %>
               <input type="hidden" name="<%= f %>" value="<%= locals[f] %>">
        <% } }); %>
      </form>
    </div>
    <div class="horizontal-filters">
      <div class="filter-dropdown">
        <select name="category" onchange="updateFilter('category', this.value)">
          <option value="">All Categories</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"
                    <%= category===cat._id?'selected':'' %>>
              <%= cat.name %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="filter-dropdown">
        <select name="brand" onchange="updateFilter('brand', this.value)">
          <option value="">All Brands</option>
          <% brands.forEach(br => { %>
            <option value="<%= br._id %>"
                    <%= brand===br._id?'selected':'' %>>
              <%= br.name %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="filter-dropdown">
        <select name="size" onchange="updateFilter('size', this.value)">
          <option value="">All Sizes</option>
          <% variantSizes.forEach(sz => { %>
            <option value="<%= sz %>"
                    <%= size===sz?'selected':'' %>>
              <%= sz.size.toUpperCase() %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="filter-dropdown">
        <select name="color" onchange="updateFilter('color', this.value)">
          <option value="">All Colors</option>
          <% variantColors.forEach(cl => { %>
            <option value="<%= cl %>"
                    <%= color===cl?'selected':'' %>>
              <%= cl.color.charAt(0).toUpperCase()+cl.color.slice(1) %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>
  </section>

  <div class="container">
    <button class="mobile-filter-btn" onclick="toggleMobileFilter()">
      <i class="fas fa-filter"></i> Filters
    </button>

    <div class="row">
      <!-- Sidebar -->
      <aside class="col col-3 desktop-sidebar">
        <div class="sidebar-filters">
          <!-- Price -->
          <div class="filter-group">
            <h5 class="filter-title">Price Range</h5>
            <div class="price-range">
              <% [ '', '0-50','50-100','100-200','200+' ].forEach(r => {
                   const label = r? r.replace('-','–').replace('+','+') : 'All Prices'; %>
                <label>
                  <input type="radio" name="priceRange" value="<%= r %>"
                         <%= priceRange===r?'checked':'' %>
                         onchange="updateFilter('priceRange', this.value)">
                  <%= label %>
                </label>
              <% }) %>
            </div>
          </div>
          <!-- Rating -->
          <div class="filter-group">
            <h5 class="filter-title">Rating</h5>
            <div class="rating-options">
              <% [4,3,2].forEach(r => { %>
                <a href="#"
                   class="rating-btn <%= rating==r?'active':'' %>"
                   onclick="updateFilter('rating','<%= r %>')">
                  <%= r %>+ Stars
                </a>
              <% }) %>
            </div>
          </div>
          <div class="filter-group">
            <a href="/user/products/shop" class="btn btn-ghost" style="width:100%;">Clear All</a>
          </div>
        </div>
      </aside>

      <!-- Products & Sorting -->
      <main class="col col-9">
        <div class="sort-controls">
          <div class="results-info">
            Showing <%= ((currentPage-1)*limit)+1 %>–
            <%= Math.min(currentPage*limit, totalProducts) %>
            of <%= totalProducts %> products
          </div>
          <div class="sort-dropdown">
            <select name="sortBy" onchange="updateFilter('sortBy', this.value)">
              <option value="newest"    <%= sortBy==='newest'?'selected':'' %>>Newest</option>
              <option value="price-low" <%= sortBy==='price-low'?'selected':'' %>>Price: Low→High</option>
              <option value="price-high"<%= sortBy==='price-high'?'selected':'' %>>Price: High→Low</option>
              <option value="name-asc"  <%= sortBy==='name-asc'?'selected':'' %>>Name A→Z</option>
              <option value="name-desc" <%= sortBy==='name-desc'?'selected':'' %>>Name Z→A</option>
              <option value="rating-high"<%= sortBy==='rating-high'?'selected':'' %>>Top Rated</option>
            </select>
          </div>
        </div>

        <div class="products-grid">
          <% if (products.length) { %>
            <% products.forEach(p => { %>
              <div class="product-item" onclick="goToProductPage('<%= p._id %>')">
                <img src="<%= p.images[0]||'/img/default.jpg' %>" alt="<%= p.name %>">
                <div class="product-details">
                  <h6><%= p.name %></h6>
                  <div class="price-info">
                    <% if (p.salePrice>0 && p.salePrice<p.regularPrice) { %>
                      <span class="sale-price">₹<%= p.salePrice.toFixed(2) %></span>
                    <% } %>
                    <span class="regular-price">₹<%= p.regularPrice.toFixed(2) %></span>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No products match your filters. <a href="/user/products/shop">Reset filters</a>.</p>
          <% } %>
        </div>

        <% if (totalPages>1) { %>
          <div class="pagination-wrapper">
            <ul class="pagination">
              <% if (currentPage>1) { %>
                <li><a href="<%= buildPaginationUrl(currentPage-1) %>">&laquo;</a></li>
              <% } %>
              <% for (let i=Math.max(1,currentPage-2); i<=Math.min(totalPages,currentPage+2); i++) { %>
                <li class="<%=i===currentPage?'active':''%>">
                  <a href="<%= buildPaginationUrl(i) %>"><%=i%></a>
                </li>
              <% } %>
              <% if (currentPage<totalPages) { %>
                <li><a href="<%= buildPaginationUrl(currentPage+1) %>">&raquo;</a></li>
              <% } %>
            </ul>
          </div>
        <% } %>
      </main>
    </div>
  </div>

  <!-- Mobile filter overlay & sidebar -->
  <div class="mobile-filter-overlay" onclick="toggleMobileFilter()"></div>
  <aside class="mobile-filter-sidebar">
    <button class="close-mobile-filter" onclick="toggleMobileFilter()">&times;</button>
    <h5>Filters</h5>
    <!-- reuse same filter-groups -->
    <div class="filter-group">
      <h5 class="filter-title">Category</h5>
      <select onchange="updateFilter('category', this.value)">
        <option value="">All Categories</option>
        <% categories.forEach(cat => { %>
          <option value="<%=cat._id%>" <%=category===cat._id?'selected':''%>>
            <%=cat.name%>
          </option>
        <% })%>
      </select>
    </div>
    <div class="filter-group">
      <h5 class="filter-title">Brand</h5>
      <select onchange="updateFilter('brand', this.value)">
        <option value="">All Brands</option>
        <% brands.forEach(br => { %>
          <option value="<%=br._id%>" <%=brand===br._id?'selected':''%>>
            <%=br.name%>
          </option>
        <% })%>
      </select>
    </div>
    <div class="filter-group">
      <h5 class="filter-title">Price Range</h5>
      <div class="price-range">
        <% [ '', '0-50','50-100','100-200','200+' ].forEach(r => {
             const label = r? r.replace('-','–').replace('+','+') : 'All Prices'; %>
          <label>
            <input type="radio" name="mobilePrice" value="<%=r%>"
                   <%=priceRange===r?'checked':''%>
                   onchange="updateFilter('priceRange',this.value)">
            <%=label%>
          </label>
        <% })%>
      </div>
    </div>
    <div class="filter-group">
      <h5 class="filter-title">Size</h5>
      <select onchange="updateFilter('size', this.value)">
        <option value="">All Sizes</option>
        <% variantSizes.forEach(sz => { %>
          <option value="<%=sz%>" <%=size===sz?'selected':''%>>
            <%=sz.size.toUpperCase()%>
          </option>
        <% })%>
      </select>
    </div>
    <div class="filter-group">
      <h5 class="filter-title">Color</h5>
      <select onchange="updateFilter('color', this.value)">
        <option value="">All Colors</option>
        <% variantColors.forEach(cl => { %>
          <option value="<%=cl%>" <%=color===cl?'selected':''%>>
            <%=cl.color.charAt(0).toUpperCase()+cl.color.slice(1)%>
          </option>
        <% })%>
      </select>
    </div>
    <div class="filter-group">
      <h5 class="filter-title">Rating</h5>
      <select onchange="updateFilter('rating', this.value)">
        <option value="">All Ratings</option>
        <% [4,3,2].forEach(r => { %>
          <option value="<%=r%>" <%=rating==r?'selected':''%>>
            <%=r%>+ Stars
          </option>
        <% })%>
      </select>
    </div>
    <div class="filter-group">
      <button class="btn btn-ghost" onclick="updateFilter('', '')">Clear All</button>
    </div>
  </aside>

  <script>
    function updateFilter(field, value) {
      const url = new URL(window.location);
      if (!value) url.searchParams.delete(field);
      else url.searchParams.set(field, value);
      // reset to first page
      if (field !== 'page') url.searchParams.set('page','1');
      window.location = url.toString();
    }

    function toggleMobileFilter() {
      const ov = document.querySelector('.mobile-filter-overlay');
      const sb = document.querySelector('.mobile-filter-sidebar');
      const active = sb.classList.toggle('active');
      ov.style.display = active?'block':'none';
    }

    function goToProductPage(id) {
      window.location = `/user/products/${id}`;
    }

    function buildPaginationUrl(page) {
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      return window.location.pathname + '?' + params.toString();
    }
  </script>

</body>
</html>
